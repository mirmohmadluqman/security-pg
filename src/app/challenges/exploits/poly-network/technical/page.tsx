'use client'

import React from 'react'
import { Logo } from '@/components/Logo'
import { ThemeSelector } from '@/components/ThemeSelector'
import { Button } from '@/components/ui/button'
import { ArrowLeft, Code, Hash, Database, Skull, ShieldCheck } from 'lucide-react'
import Link from 'next/link'

export default function PolyNetworkTechnicalPage() {
    return (
        <div className="min-h-screen bg-background relative overflow-hidden flex flex-col">
            {/* Background Effects */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
                <div className="absolute top-[-10%] right-[-10%] w-[800px] h-[800px] bg-red-500/10 blur-[150px] rounded-full" />
                <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-purple-500/10 blur-[150px] rounded-full" />
            </div>

            <header className="h-20 border-b border-white/5 flex items-center justify-between px-8 relative z-50 glass sticky top-0">
                <div className="flex items-center gap-6">
                    <Link href="/challenges/exploits/poly-network">
                        <Button variant="ghost" size="sm" className="gap-2 text-muted-foreground hover:text-white">
                            <ArrowLeft className="w-4 h-4" />
                            Back to Story
                        </Button>
                    </Link>
                    <Logo />
                </div>
                <ThemeSelector />
            </header>

            <main className="flex-1 max-w-5xl mx-auto w-full p-8 md:p-12 space-y-12 relative z-10">
                <section className="space-y-4 text-center">
                    <div className="inline-flex p-3 rounded-2xl bg-purple-500/10 text-purple-400 mb-2">
                        <Hash size={32} />
                    </div>
                    <h1 className="text-5xl font-black tracking-tight">The <span className="text-purple-400">Hash Collision</span></h1>
                    <p className="text-muted-foreground text-lg">How 4 bytes of data tricked a $600M protocol.</p>
                </section>

                <div className="grid gap-8">
                    {/* Concept */}
                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h2 className="text-2xl font-bold flex items-center gap-3">
                            <Code className="text-primary" />
                            1. How EVM Calls Work
                        </h2>
                        <div className="space-y-4 text-slate-300 leading-relaxed">
                            <p>
                                In Ethereum, when you call a function, the first 4 bytes of the transaction data tell the contract <i>which</i> function to execute. This identifying tag is called the <strong>Function Selector</strong>.
                            </p>
                            <p>
                                It is calculated by taking the first 4 bytes of the Keccak-256 hash of the function signature:
                            </p>
                            <div className="bg-black/40 p-4 rounded-xl font-mono text-sm border border-white/5">
                                <p className="text-blue-400">selector = bytes4(keccak256("myFunction(uint256)"))</p>
                            </div>
                        </div>
                    </div>

                    {/* The Flaw */}
                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h2 className="text-2xl font-bold flex items-center gap-3">
                            <Skull className="text-red-400" />
                            2. The Vulnerability
                        </h2>
                        <div className="space-y-4 text-slate-300 leading-relaxed">
                            <p>
                                The Poly Network `EthCrossChainManager` contract had a function `_executeCrossChainTx` that allowed it to call <strong>any contract</strong> with <strong>any method</strong>.
                            </p>
                            <p>
                                However, it didn't take the 4-byte selector directly. It took the method name as a string and hashed it manually:
                            </p>
                            <div className="bg-black/40 p-4 rounded-xl font-mono text-sm border border-white/5 space-y-2">
                                <p className="text-gray-500">// Vulnerable Code in EthCrossChainManager.sol</p>
                                <p>bytes4 selector = bytes4(keccak256(abi.encodePacked(_method, <span className="text-yellow-400">"(bytes,bytes,uint64)"</span>)));</p>
                                <p>_toContract.call(abi.encodePacked(selector, _args));</p>
                            </div>
                            <p className="text-sm text-muted-foreground">
                                Note distinct characteristic: It forces the argument signature <code>(bytes,bytes,uint64)</code>.
                            </p>
                        </div>
                    </div>

                    {/* The Attack */}
                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6 bg-gradient-to-b from-purple-500/5 to-transparent">
                        <h2 className="text-2xl font-bold flex items-center gap-3">
                            <Database className="text-purple-400" />
                            3. The Collision Attack
                        </h2>
                        <div className="space-y-4 text-slate-300 leading-relaxed">
                            <p>
                                The attacker wanted to call a specific privileged function on the `EthCrossChainData` contract to change the network keepers:
                            </p>
                            <div className="bg-black/40 p-4 rounded-xl font-mono text-sm border border-white/5">
                                <p className="text-green-400">function putCurEpochConPubKeyBytes(bytes memory curEpochPkBytes)</p>
                            </div>
                            <p>
                                <strong>The Problem:</strong> The Manager forces the signature <code>(bytes,bytes,uint64)</code>, but the target function only accepts <code>(bytes)</code>.
                            </p>
                            <p>
                                <strong>The Solution:</strong> Hash Collision.<br />
                                The attacker brute-forced a string <code>f1121318093</code>. When this specific string is combined with the manager's forced suffix, it produces a hash that starts with the <strong>same 4 bytes</strong> (0x41973cd9) as the target function.
                            </p>

                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="p-4 rounded-xl bg-red-500/10 border border-red-500/20">
                                    <h4 className="font-bold text-red-400 mb-2">Attacker's Input</h4>
                                    <p className="font-mono text-xs break-all">
                                        bytes4(keccak256("f1121318093(bytes,bytes,uint64)"))
                                    </p>
                                    <p className="font-mono text-xl font-black text-white mt-2">0x41973cd9</p>
                                </div>
                                <div className="p-4 rounded-xl bg-green-500/10 border border-green-500/20">
                                    <h4 className="font-bold text-green-400 mb-2">Target Function</h4>
                                    <p className="font-mono text-xs break-all">
                                        bytes4(keccak256("putCurEpochConPubKeyBytes(bytes)"))
                                    </p>
                                    <p className="font-mono text-xl font-black text-white mt-2">0x41973cd9</p>
                                </div>
                            </div>

                            <p>
                                The EVM only looks at the first 4 bytes. It doesn't care about the rest of the arguments matching. Since the selectors matched, the Data contract accepted the call and updated the keepers to the attacker's address.
                            </p>
                        </div>
                    </div>

                    {/* Prevention */}
                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h2 className="text-2xl font-bold flex items-center gap-3">
                            <ShieldCheck className="text-green-400" />
                            4. Prevention
                        </h2>
                        <ul className="list-disc list-inside space-y-3 text-slate-300">
                            <li><strong className="text-white">Input Validation:</strong> Never allow users to specify arbitrary contract addresses for privileged calls. Whitelist allowed targets.</li>
                            <li><strong className="text-white">Selector Safety:</strong> Avoid reconstructing function selectors dynamically from user input strings.</li>
                            <li><strong className="text-white">Defense in Depth:</strong> Critical contracts (like Data storage) should only accept calls from specific logic contracts, but those logic contracts typically shouldn't have "generic execution" capabilities.</li>
                        </ul>
                    </div>
                </div>
            </main>
        </div>
    )
}
